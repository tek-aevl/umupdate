#!/bin/sh
# kernel-check: compare running kernel to newest installed (modules dirs)
# POSIX sh, distro-agnostic

# Colors (TTY-aware)
if [ -t 1 ] && command -v tput >/dev/null 2>&1; then
  RED="$(tput setaf 1)"; YEL="$(tput setaf 3)"; GRN="$(tput setaf 2)"
  MAG="$(tput setaf 5)"; BLU="$(tput setaf 4)"; WHT="$(tput setaf 7)"
  BLD="$(tput bold)"; RST="$(tput sgr0)"
else
  RED=""; YEL=""; GRN=""; MAG=""; BLU=""; WHT=""; BLD=""; RST=""
fi
say(){ printf "%s\n" "$*"; }

# Optional: --reboot to actually reboot when an older kernel is detected
DO_REBOOT=0
case "$1" in
  --reboot|-r) DO_REBOOT=1 ;;
esac

do_reboot() {
  say "${YEL}Rebooting to load kernel ${CKNEWEST}...${RST}"
  if command -v systemctl >/dev/null 2>&1; then
    systemctl reboot
  elif command -v reboot >/dev/null 2>&1; then
    reboot
  elif command -v shutdown >/dev/null 2>&1; then
    shutdown -r now
  else
    say "${RED}No reboot utility found (systemctl/reboot/shutdown).${RST}"
    exit 3
  fi
}

# Locate module roots
roots=""
[ -d /usr/lib/modules ] && roots="$roots /usr/lib/modules"
[ -d /lib/modules ]     && roots="$roots /lib/modules"
[ -z "$roots" ] && { say "${RED}No modules directory found.${RST}"; exit 2; }

# List version dirnames safely
cklist_versions() {
  for r in $roots; do
    for d in "$r"/*; do
      [ -d "$d" ] || continue
      printf "%s\n" "${d##*/}"
    done
  done
}

ckuniq_stable(){ awk '!seen[$0]++'; }
ckver_sort(){ if sort -V </dev/null >/dev/null 2>&1; then sort -V; else sort; fi; }

CKRUNNING="$(uname -r)"
ALL="$(cklist_versions | ckuniq_stable)"
[ -z "$ALL" ] && { say "${RED}No kernel versions found under: $roots${RST}"; exit 2; }
CKNEWEST="$(printf "%s\n" "$ALL" | ckver_sort | tail -n1)"

# Pretty output
say "${RED}This text is Red.${RST}"
say "${YEL}This text is Yellow.${RST}"
say "${GRN}This text is Green.${RST}"
say "${MAG}This text is Magenta.${RST}"
say "${BLU}This text is Blue.${RST}"
say "${WHT}This text is White.${RST}"
say "${BLD}Running Kernel:${RST}   $CKRUNNING"
say "${BLD}Newest Installed:${RST} $CKNEWEST"

if [ "$CKRUNNING" = "$CKNEWEST" ]; then
  say "${GRN}✅ Running kernel matches the newest installed. No action needed.${RST}"
  exit 0
fi

# If running modules dir exists, hint older vs different
if [ -d "/usr/lib/modules/$CKRUNNING" ] || [ -d "/lib/modules/$CKRUNNING" ]; then
  if sort -V </dev/null >/dev/null 2>&1; then
    CKFIRST="$(printf "%s\n%s\n" "$CKRUNNING" "$CKNEWEST" | ckver_sort | head -n1)"
    if [ "$CKFIRST" = "$CKRUNNING" ] && [ "$CKRUNNING" != "$CKNEWEST" ]; then
say "${YEL}⚠️ Running kernel appears OLDER than newest installed.${RST}" 
[ "$DO_REBOOT" -eq 1 ] && do_reboot
    else
      say "${YEL}ℹ️ Running kernel differs (flavor or naming).${RST}"
    fi
  else
    say "${YEL}ℹ️ Running kernel differs from newest installed.${RST}"
  fi
  exit 1
fi

say "${RED}❌ Modules directory for the running kernel is missing:${RST} ${BLD}/(usr)?/lib/modules/$CKRUNNING${RST}"
say "${RED}Rebuild initramfs or reinstall the kernel, then reboot.${RST}"

